log_format upstreamlog '[$time_local] $remote_addr - $remote_user - $server_name to: $upstream_addr: $status / upstream $upstream_status $request upstream_response_time $upstream_response_time msec $msec request_time $request_time body: $request_body';
server {
  listen       80;
  server_name  localhost;

  underscores_in_headers on;

  location /healthcheck {
    expires -1;
    access_log off;
    default_type application/json;
    return 200 '{"online" : true}';
  }

  location /version {
    expires -1;
    access_log off;
    default_type application/json;
    return 200 '{"version": "PKG_VERSION"}';
  }

  location /assets/ {
    expires max;
    access_log /var/log/nginx-upstream.log upstreamlog;
    resolver 8.8.8.8 valid=300s;
    resolver_timeout 10s;
    limit_except GET {
      deny all;
    }
    rewrite /assets/(.*) /$1 break;
    proxy_redirect off;
    proxy_ignore_headers set-cookie;
    proxy_hide_header set-cookie;
    proxy_set_header cookie "";
    proxy_hide_header x-amz-delete-marker;
    proxy_hide_header x-amz-id-2;
    proxy_hide_header x-amz-request-id;
    proxy_hide_header x-amz-version-id;
    proxy_hide_header etag;
    proxy_buffering off;
    proxy_intercept_errors on;
    proxy_set_header Host app-static.octoblu.com;
    proxy_ssl_server_name on;
    proxy_pass https://app-static.octoblu.com/vPKG_VERSION;
  }

  location / {
    expires max;
    access_log off;
    if ($http_x_forwarded_proto = 'http') {
      return 301 https://app.octoblu.com$request_uri;
    }
    root /usr/share/nginx/html/public;
    index  index.html;
    try_files $uri /index.html;
  }
}
